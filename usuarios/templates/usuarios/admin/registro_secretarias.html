{% extends "usuarios/admin/base_admin.html" %}

{% block content %}

    <h4 class="mb-4">Gestión y Registro de Secretarias</h4>
    
    <style>
        .col-acciones {
            width: 210px !important;
        }
    </style>

    <!-- CONTENEDOR PRINCIPAL CON BUSCADOR Y BOTÓN -->
    <div class="row mb-3 align-items-center">
        <!-- BUSCADOR (IZQUIERDA) -->
        <div class="col-md-8">
            <input type="text" class="form-control" id="search_secretaria" 
                   onkeyup="filterTable('secretarias-table')" 
                   placeholder="Buscar por Código o Nombre...">
        </div>
        
        <!-- BOTÓN AÑADIR SECRETARIA (DERECHA) -->
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#formCrearSecretaria">
                <i class="bi bi-person-plus"></i> Añadir Secretaria
            </button>
        </div>
    </div>

    <!-- FORMULARIO COLAPSABLE PARA CREAR SECRETARIA -->
    <div class="collapse mb-4" id="formCrearSecretaria">
        <div class="card card-body shadow-sm">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="crear_secretaria" value="1">

                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Código de Secretaria</label>
                        <input type="text" name="secretaria_id" class="form-control" required>
                    </div>

                    <div class="col-md-4 mb-2">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" name="nombre" class="form-control" required>
                    </div>

                    <div class="col-md-4 mb-2">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control">
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Contraseña</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-2">
                    <i class="bi bi-save"></i> Guardar Secretaria
                </button>
            </form>
        </div>
    </div>

    <!-- TABLA DE SECRETARIAS -->
    <div class="table-responsive card shadow-sm">
        <table class="table table-bordered table-striped table-hover mb-0" id="secretarias-table">
            <thead class="table-dark">
                <tr>
                    <th onclick="sortTable(0, 'secretarias-table')">Código</th>
                    <th onclick="sortTable(1, 'secretarias-table')">Nombre Completo</th>
                    <th>Email</th>
                    <th>Estado</th>
                    <th class="text-center col-acciones">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for secretaria in secretarias %}
                <tr>
                    <td>{{ secretaria.perfil.id }}</td>
                    <td>{{ secretaria.perfil.nombre }}</td>
                    <td>{{ secretaria.perfil.email|default:"-" }}</td>
                    <td>
                        <span class="badge bg-{% if secretaria.perfil.estadoCuenta %}success{% else %}danger{% endif %}">
                            {% if secretaria.perfil.estadoCuenta %}Activo{% else %}Inactivo{% endif %}
                        </span>
                    </td>
                    <td class="text-center">
                        <!-- BOTÓN EDITAR -->
                        <button class="btn btn-sm btn-info text-white me-2"
                                data-bs-toggle="modal"
                                data-bs-target="#modalEditarSecretaria"
                                data-id="{{ secretaria.perfil.id }}"
                                data-nombre="{{ secretaria.perfil.nombre }}"
                                data-email="{{ secretaria.perfil.email }}"
                                data-estado="{{ secretaria.perfil.estadoCuenta }}"
                                title="Editar Secretaria">
                            <i class="bi bi-pencil"></i>
                        </button>

                        <!-- BOTÓN HABILITAR/DESHABILITAR -->
                        <form method="POST" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="toggle_estado" value="1">
                            <input type="hidden" name="secretaria_id" value="{{ secretaria.perfil.id }}">
                            <button class="btn btn-sm {% if secretaria.perfil.estadoCuenta %}btn-warning{% else %}btn-success{% endif %}" 
                                    title="{% if secretaria.perfil.estadoCuenta %}Deshabilitar{% else %}Habilitar{% endif %}">
                                {% if secretaria.perfil.estadoCuenta %}
                                    <i class="bi bi-lock"></i>
                                {% else %}
                                    <i class="bi bi-unlock"></i>
                                {% endif %}
                            </button>
                        </form>

                        <!-- BOTÓN ELIMINAR -->
                        <form method="POST" class="d-inline ms-2"
                            onsubmit="return confirm('¿Seguro que deseas eliminar definitivamente esta secretaria?');">
                            {% csrf_token %}
                            <input type="hidden" name="eliminar_secretaria" value="1">
                            <input type="hidden" name="secretaria_id" value="{{ secretaria.perfil.id }}">
                            <button class="btn btn-sm btn-outline-danger" title="Eliminar Secretaria">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No hay secretarias registradas en la base de datos.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- MODAL PARA EDITAR SECRETARIA -->
    <div class="modal fade" id="modalEditarSecretaria" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="editar_secretaria" value="1">
                    <input type="hidden" name="secretaria_id" id="edit-id">

                    <div class="modal-header">
                        <h5 class="modal-title">Editar Secretaria</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Código de Secretaria</label>
                            <input type="text" id="edit-codigo" class="form-control" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" name="nombre" id="edit-nombre" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" id="edit-email" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Estado de Cuenta</label>
                            <select name="estadoCuenta" id="edit-estado" class="form-select">
                                <option value="True">Activo</option>
                                <option value="False">Inactivo</option>
                            </select>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        function filterTable(tableId) {
            var input = document.getElementById("search_secretaria");
            var filter = input.value.toUpperCase();
            var table = document.getElementById(tableId);
            var tr = table.getElementsByTagName("tr");

            for (var i = 1; i < tr.length; i++) {
                tr[i].style.display = "none";
                var td = tr[i].getElementsByTagName("td");

                if (td.length > 0) {
                    var code = td[0].innerText.toUpperCase();
                    var name = td[1].innerText.toUpperCase();

                    if (code.includes(filter) || name.includes(filter)) {
                        tr[i].style.display = "";
                    }
                }
            }
        }

        function sortTable(n, tableId) {
            var table = document.getElementById(tableId);
            var switching = true;
            var dir = "asc";

            while (switching) {
                switching = false;
                var rows = table.rows;

                for (var i = 1; i < rows.length - 1; i++) {
                    var x = rows[i].getElementsByTagName("TD")[n];
                    var y = rows[i + 1].getElementsByTagName("TD")[n];
                    if (!x || !y) continue;

                    var xContent = isNaN(x.innerText) ? x.innerText.toLowerCase() : parseFloat(x.innerText);
                    var yContent = isNaN(y.innerText) ? y.innerText.toLowerCase() : parseFloat(y.innerText);

                    var shouldSwitch = (dir === "asc" && xContent > yContent) ||
                                       (dir === "desc" && xContent < yContent);

                    if (shouldSwitch) {
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        break;
                    }
                }

                if (!switching && dir === "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('modalEditarSecretaria');

            modal.addEventListener('show.bs.modal', function(event) {
                var button = event.relatedTarget;

                var id = button.getAttribute('data-id');
                var nombre = button.getAttribute('data-nombre');
                var email = button.getAttribute('data-email');
                var estado = button.getAttribute('data-estado');

                document.getElementById('edit-id').value = id;
                document.getElementById('edit-codigo').value = id;
                document.getElementById('edit-nombre').value = nombre;
                document.getElementById('edit-email').value = email ?? "";
                document.getElementById('edit-estado').value = estado;
            });
        });
    </script>

{% endblock content %}